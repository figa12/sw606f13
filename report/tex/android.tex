\todo{This Chapter describes the Android platform, and which key functionality of the Android platform that we have used.}
\section{Drag and Drop}
\label{sec:androiddraganddrop}
This section will explain how drag and drop works in version Android SDK 11 or greater. It will explain how to start a drag, what happens when view is dragged on the screen, and finally what happens when the view is dropped.
\subsection*{Overview}
Before we begin explaining drag and drop we first need to introduce the terms Listener, View and ViewGroup.
\begin{description}
\item[View] is a base class for user interface components. A View represents a square on the device's screen, and is responsible for drawing and event handling. A example of the View class could be a ImageView, which is used to display a image.
\item[ViewGroup] is a subclass of the View class, and is a base class for all layouts, which are invisible containers for Views or other ViewGroups.
\item[Listeners] are attached to a View and is mostly used to receive and handle user input. Every Listener has a \lstinline|OnSomething()| method, this method is called when the system receive a gesture on the Listener's View. A simple example of a Listener is the TouchListener, The \lstinline|OnTouch()| method is called every time the TouchListener's View receives a touch gesture.
\end{description}

\subsection*{Drag Shadow}
Before we can make a drag we must first create something called a drag shadow. A drag shadow is basically a copy of the View you are trying to drag and follows the position of the finger.\autoref{lst:makedragshadow} shows how to create drag shadow and start a drag on a view.
\begin{lstlisting}[language=java,firstnumber=1,caption={How to create a drag shadow, and start drag},label=lst:makedragshadow]
imageView.setOnTouchListener(new OnTouchListener(){
	public boolean onTouch(View view, MotionEvent motionEvent){
		if (motionEvent.getAction() == MotionEvent.ACTION_DOWN) {
			ClipData data = ClipData.newPlainText("", "");
			DragShadowBuilder shadow = new View.DragShadowBuilder(view);
			view.startDrag(data, shadow, null, 0);
			return true;
		}
		else {
			return false;
		}	
	}
});
\end{lstlisting}
\begin{description}
\item[Line 1] set a \lstinline|OnTouchListener| on the View \lstinline|imageView|
\item[Line 2 \& 3] The \lstinline|OnTouch()| method that the system calls when the View receives the input gesture, and if the gesture is a press motion it will continue.
\item[Line 4 \& 5] \lstinline|ClipData| is used to store data about the view being dragged. \lstinline|shadow| is initialized with the touched \lstinline|view|.
\item[Line 6] The \lstinline|view.startDrag()| start the drag on the View(\lstinline|imageView|). This will cause every OnDragListeners to be called. 
\item[Line 7 \& 10] Return either true or false based on if the event was handled or not.
\end{description}
\subsection*{Drag Events}
A OnDragListener can be attached to the View class or its subclasses. When the method \lstinline|OnDrag()| is called on each of the OnDragListeners it can enter one of these 4 four states.
\begin{description}
\item[Started] When a drag has been started with the method \lstinline|startDrag()|, the system draws the drag shadow, and sends a drag event with the action \lstinline|ACTION_DRAG_STARTED| to all the OnDragLinsteners. If the OnDragListener returns true it will continue to receive drag events, if it return false, it will stop receiving drag events, and the view can not accept the dragged data.

\item[Dragging] If the user continues to drag the shadow, and enters a View's boundaries. The system will send a drag event to the View's OnDragListener with the action \lstinline|ACTION_DRAG_ENTERED|, and \lstinline|ACTION_DRAG_EXITED| when the drag shadow exits the View's boundaries. 

\item[Dropped] If the user releases the drag shadow over a View, the View's OnDragListener receives a drag event with the action \lstinline|ACTION_DROP|. The drag event is not sent if the OnDragListener returned false in the started state. The OnDragListener is expected to return true if the drop was successfully processed and otherwise false.

\item[Ended] After the user has released the drag shadow, the system sends out a drag event with the action \lstinline|ACTION_DRAG_ENDED|.

\end{description}

\section{Listview}
The menu for customisation in this project consists of three lists and it would thus be obvious to use the \lstinline|ListView| class from the Android developers guide \citep{androidlayouts}. This proved to be quite the challenge, since the \lstinline|ListView| does not seem to be made for adding and removing items since its initial population. It seems that it is build for showing a dataset in a list form, but if you want to change this dataset during runtime, you run into a lot of problems. There are plenty of examples of people who struggle to use the \lstinline|ListView| class and what seemed to cause a lot of our problems is the \lstinline|NotifyDataSetChanged| method from the underlying adapter \citep{listviewfail,notifydatasetchanged}. The documentation of this method is very vague and we could not get our list to update with new data.

We chose to implement our own list classes for populating the saved game configurations list and the stations list. By using the \lstinline|LinearLayout| class from the Android developers guide we are able to add and remove views during runtime \citep{androidlayouts}. When we put the \lstinline|LinearLayout| inside a \lstinline|ScrollView| what we get is almost similar to a \lstinline|ListView|.

The first list in the menu contains the children, it is made with the ListView class, this could be done since it does not have to be manipulated after the initial load of children. The second list in the menu contains game configurations called \lstinline|GameLinearLayout|, it is made with \lstinline|LinearLayout| and some of it is described below. The third list in the menu contains station configurations called \lstinline|CustomiseLinearlayout|, it is also made with a \lstinline|LinearLayout| that does almost the same thing as the \lstinline|GameLinearLayout|.

\subsection*{GameLinearLayout}

The class we made to show a list of saved games it is called \lstinline|GameLinearLayout|.

\begin{lstlisting}[language=java,firstnumber=1,caption={The method to create a list item.},label=lst:makeview]
private void makeView(GameConfiguration gameConfiguration) {
    LayoutInflater layoutInflater = (LayoutInflater) getContext().getSystemService(Context.LAYOUT_INFLATER_SERVICE);
    /* Use same layout style as the profile list */
    View gameListItem = layoutInflater.inflate(R.layout.game_list_item);
    
    TextView gameNameTextView = (TextView) gameListItem.findViewById(R.id.gameName);
    gameNameTextView.setText(gameConfiguration.getGameName());

    ImageView gameIconImageView = (ImageView) gameListItem.findViewById(R.id.gameIcon);
    
    Bitmap bitmap = BitmapFactory.decodeFile(PictoFactory.INSTANCE.getPictogram(super.getContext(),gameConfiguration.getStation(0).getCategory()).getImagePath());
    gameIconImageView.setImageBitmap(bitmap);
    
    gameListItem.setOnClickListener(new OnItemClickListener(gameConfiguration));
    gameListItem.setOnLongClickListener(new OnItemLongClickListener(gameConfiguration));

    /* Add to the list of visible configurations */
    this.visibleGameConfigurations.add(gameConfiguration);
    super.addView(gameListItem);
}
\end{lstlisting}
\begin{description}
\item[Line 1] \lstinline|makeView| takes a \lstinline|GameConfiguration| which contains all relevant information about the saved game.
\item[Lines 2-4] Creates a new \lstinline|View| for the \lstinline|GameConfiguration| based on our layout for a game list item.
\item[Lines 6-7] Gets the name of the game and sets it in the list item.
\item[Lines 9-12] Gets the category pictogram of the first station in the game configuration and sets this as a game icon for the list item.
\item[Lines 14-15] Set a \lstinline|LongClickListener| and a \lstinline|ClickListener| on the item. These are both listeners that we have made. The normal click will select the item and show its details in the customisation list. The long click will show a dialog that asks you whether you want to delete it or not.
\item[Lines 18-19] Add the item to the list of saved games, and add the view to the \lstinline|LinearLayout|.
\end{description}
